package matcher

import (
	"encoding/json"
	"os"
	"testing"

	"github.com/CodeClarityCE/plugin-sca-vuln-finder/src/conflictResolver"
	ecosystemTypes "github.com/CodeClarityCE/plugin-sca-vuln-finder/src/ecosystemAnalyzer/types"
	npmRepository "github.com/CodeClarityCE/plugin-sca-vuln-finder/src/repository/npm"
	vulnerabilityFinder "github.com/CodeClarityCE/plugin-sca-vuln-finder/src/types"
	"github.com/CodeClarityCE/plugin-sca-vuln-finder/src/types/conflict"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestClean(t *testing.T) {
	vm := VulnerabilityMatcher{
		Ecosystems:        []ecosystemTypes.Ecosystem{ecosystemTypes.NODEJS_OR_JS},
		ConflictResolver:  conflictResolver.TrustOSV,
		PackageRepository: npmRepository.NpmPackageRepository,
	}

	// Read the NVD unit fixture
	jsonData, err := os.ReadFile("test_data/nvd_unit.json")
	require.NoError(t, err)
	var nvdMatches []vulnerabilityFinder.NVDVulnerability
	err = json.Unmarshal(jsonData, &nvdMatches)
	require.NoError(t, err)

	// Read the OSV unit fixture
	jsonData, err = os.ReadFile("test_data/osv_unit.json")
	require.NoError(t, err)
	var osvMatches []vulnerabilityFinder.OSVVulnerability
	err = json.Unmarshal(jsonData, &osvMatches)
	require.NoError(t, err)

	var gcveMatches []vulnerabilityFinder.GCVEVulnerability
	result := vm.clean(nvdMatches, osvMatches, gcveMatches)

	// Verify we got 2 vulnerability entries
	assert.Len(t, result, 2)

	// Check NVD-only vulnerability
	nvdPairs, ok := result["CVE-2021-1234"]
	assert.True(t, ok, "Expected CVE-2021-1234 in result")
	assert.Len(t, nvdPairs, 1)
	nvdPair, ok := nvdPairs["example@1.0.0"]
	assert.True(t, ok, "Expected example@1.0.0 dep key")
	assert.Equal(t, "CVE-2021-1234", nvdPair.NVD.Vulnerability.NVDId)
	assert.Equal(t, "example", nvdPair.NVD.Dependency.Name)
	// TrustOSV: when OSV.Cve is empty, returns (NVD, MATCH_POSSIBLE_INCORRECT)
	assert.Equal(t, conflict.NVD, nvdPair.ConflictWinner)
	assert.Equal(t, conflict.MATCH_POSSIBLE_INCORRECT, nvdPair.ConflictFlag)

	// Check OSV-only vulnerability
	// OSV has aliases=["CVE-2021-5678"] and it's not already in pairs, so vulnID becomes "CVE-2021-5678"
	osvPairs, ok := result["CVE-2021-5678"]
	assert.True(t, ok, "Expected CVE-2021-5678 in result (from OSV alias)")
	assert.Len(t, osvPairs, 1)
	osvPair, ok := osvPairs["example@2.0.0"]
	assert.True(t, ok, "Expected example@2.0.0 dep key")
	assert.Equal(t, "OSV-2021-5678", osvPair.OSV.Vulnerability.OSVId)
	assert.Equal(t, "example", osvPair.OSV.Dependency.Name)
	// TrustOSV: when OSV.Cve is not empty, returns (OSV, MATCH_CORRECT)
	assert.Equal(t, conflict.OSV, osvPair.ConflictWinner)
	assert.Equal(t, conflict.MATCH_CORRECT, osvPair.ConflictFlag)
}
