package matcher

import (
	vulnerabilityFinder "github.com/CodeClarityCE/plugin-sca-vuln-finder/src/types"
	"github.com/CodeClarityCE/plugin-sca-vuln-finder/src/types/conflict"
)

func (vm VulnerabilityMatcher) clean(nvdMatches []vulnerabilityFinder.NVDVulnerability, osvMatches []vulnerabilityFinder.OSVVulnerability, gcveMatches []vulnerabilityFinder.GCVEVulnerability) map[string]map[string]vulnerabilityFinder.Pairs {
	pairs := make(map[string]map[string]vulnerabilityFinder.Pairs)

	for _, match := range nvdMatches {
		vulnID := match.Vulnerability.NVDId
		depKey := match.Dependency.Name + "@" + match.Dependency.Semver.String()

		vulnConflicts, ok := pairs[vulnID]
		// Check if vuln was already present
		if !ok {
			vulnConflicts = make(map[string]vulnerabilityFinder.Pairs)
			pairs[vulnID] = vulnConflicts
		}

		depConflict, ok := vulnConflicts[depKey]
		// Check if dep was already present for this vuln
		if !ok {
			depConflict = vulnerabilityFinder.Pairs{
				NVD:            match,
				ConflictWinner: conflict.NONE,
			}
		}

		depConflict.NVD = match
		vulnConflicts[depKey] = depConflict
	}

	for _, match := range osvMatches {
		vulnID := match.Vulnerability.OSVId
		for _, cveID := range match.Vulnerability.Aliases {
			_, ok := pairs[cveID]
			if !ok {
				vulnID = cveID
				break
			}
		}

		_, ok := pairs[match.Vulnerability.Cve]
		if ok {
			vulnID = match.Vulnerability.Cve
		}

		vulnConflicts, ok := pairs[vulnID]
		// Check if vuln was already present
		if !ok {
			vulnConflicts = make(map[string]vulnerabilityFinder.Pairs)
			pairs[vulnID] = vulnConflicts
		}

		depKey := match.Dependency.Name + "@" + match.Dependency.Semver.String()

		depConflict, ok := vulnConflicts[depKey]
		// Check if dep was already present for this vuln
		if !ok {
			depConflict = vulnerabilityFinder.Pairs{
				ConflictWinner: conflict.NONE,
			}
		}

		depConflict.OSV = match
		vulnConflicts[depKey] = depConflict
	}

	// Merge GCVE matches by correlating on CVE ID
	for _, match := range gcveMatches {
		// Use the CVE ID from the GCVE record for cross-referencing with NVD/OSV
		vulnID := match.Vulnerability.CVEId
		if vulnID == "" {
			vulnID = match.Vulnerability.GCVEId
		}

		// Check if this CVE already exists under a different key
		if _, ok := pairs[vulnID]; !ok {
			// Try matching against existing pairs by GCVE ID
			if match.Vulnerability.GCVEId != "" {
				if _, ok := pairs[match.Vulnerability.GCVEId]; ok {
					vulnID = match.Vulnerability.GCVEId
				}
			}
		}

		vulnConflicts, ok := pairs[vulnID]
		if !ok {
			vulnConflicts = make(map[string]vulnerabilityFinder.Pairs)
			pairs[vulnID] = vulnConflicts
		}

		depKey := match.Dependency.Name + "@" + match.Dependency.Semver.String()

		depConflict, ok := vulnConflicts[depKey]
		if !ok {
			depConflict = vulnerabilityFinder.Pairs{
				ConflictWinner: conflict.NONE,
			}
		}

		depConflict.GCVE = match
		vulnConflicts[depKey] = depConflict
	}

	for _, vuln := range pairs {
		for dep_id, conflictData := range vuln {
			conflictData.ConflictWinner, conflictData.ConflictFlag = vm.ConflictResolver(conflictData)
			vuln[dep_id] = conflictData
		}
	}

	return pairs
}
