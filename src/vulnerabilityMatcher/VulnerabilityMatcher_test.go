package matcher

import (
	"encoding/json"
	"os"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"

	vulnerabilityFinder "github.com/CodeClarityCE/plugin-sca-vuln-finder/src/types"
	"github.com/CodeClarityCE/plugin-sca-vuln-finder/src/types/conflict"
)

func TestParsePairs(t *testing.T) {
	jsonData, err := os.ReadFile("test_data/pairs_unit.json")
	require.NoError(t, err)
	var pairs map[string]map[string]vulnerabilityFinder.Pairs
	err = json.Unmarshal(jsonData, &pairs)
	require.NoError(t, err)

	owaspTop10CWEListViewIds := []string{"1345", "1346", "1347", "1348", "1349", "1352", "1353", "1354", "1355", "1356"}

	// Pass nil for knowledge DB since test data has no CWE IDs to look up
	vulnerabilities := parsePairs(pairs, nil, owaspTop10CWEListViewIds)

	// Assert the expected number of vulnerabilities
	require.Len(t, vulnerabilities, 1)

	// Assert the properties of the first vulnerability
	assert.Equal(t, "CVE-2021-1234", vulnerabilities[0].VulnerabilityId)
	assert.Equal(t, "example", vulnerabilities[0].AffectedDependency)
	assert.Equal(t, "1.0.0", vulnerabilities[0].AffectedVersion)
	assert.Contains(t, vulnerabilities[0].Sources, vulnerabilityFinder.NVD)
	assert.NotNil(t, vulnerabilities[0].NVDMatch)
	assert.Nil(t, vulnerabilities[0].OSVMatch)
	assert.Nil(t, vulnerabilities[0].GCVEMatch)
	assert.Empty(t, vulnerabilities[0].Weaknesses)
	assert.Equal(t, conflict.ResolveWinner("NVD"), vulnerabilities[0].Conflict.ConflictWinner)
	assert.Equal(t, conflict.ConflictFlag("MATCH_POSSIBLE_INCORRECT"), vulnerabilities[0].Conflict.ConflictFlag)
}
